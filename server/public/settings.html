<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Inky Settings</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 20px;
  }

  h2 {
    margin-top: 0;
  }

  .layout {
    display: flex;
    gap: 24px;
    align-items: flex-start;
  }

  .left,
  .right {
    flex: 1;
    min-width: 0;
  }

  input {
    padding: 8px;
    margin: 6px 0;
  }

  button {
    padding: 8px 16px;
    margin-top: 10px;
  }

  .status {
    background: #f3f3f3;
    padding: 10px;
    margin-top: 20px;
    font-size: 0.9em;
  }

  .row {
    margin-bottom: 20px;
  }

  #thumbnails {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }

  #thumbnails img {
    width: 100%;
    height: auto;
    border: 1px solid #ccc;
    background: white;
  }

.thumb {
  position: relative;
  display: inline-block;
  margin: 6px;
}

.thumb.current {
  outline: 3px solid #4caf50;
  outline-offset: 2px;
}

.thumb.current::after {
  content: "LIVE";
  position: absolute;
  top: 4px;
  left: 4px;
  background: #4caf50;
  color: #000;
  font-size: 10px;
  padding: 2px 4px;
}

.thumb button {
  opacity: 0;
  transition: opacity 0.2s;
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0,0,0,0.7);
  color: white;
  border: none;
  padding: 2px 6px;
  cursor: pointer;
  font-size: 12px;
}

.thumb button:hover {
  background: red;
}

.thumb:hover button {
  opacity: 1;
}

  /* Mobile fallback */
  @media (max-width: 800px) {
    .layout {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<h2>Inky Display Settings</h2>

<div class="layout">

  <!-- LEFT PANEL -->
  <div class="left">

    <div class="row">
      <label>RSS Feed URL</label>
      <input id="rssUrl" placeholder="https://…" />
    </div>

    <div class="row">
      <h3>Current RSS Preview</h3>
      <div id="preview">Loading…</div>
    </div>

    <div class="row">
      <h3>Scheduler Status</h3>
      <div class="status" id="status">Loading…</div>
    </div>

    <div class="row">
      <label>Display Mode</label><br>
      <label><input type="radio" name="mode" value="rss"> RSS</label>
      <label><input type="radio" name="mode" value="slideshow"> Slideshow</label>
    </div>

    <div class="row">
      <label>Upload Image (Slideshow)</label><br>
      <input type="file" id="image">
      <button onclick="upload()">Upload</button>
    </div>

    <button onclick="save()">Save & Refresh</button>
    <button onclick="refreshDisplay()">Refresh display now</button>

  </div>

  <!-- RIGHT PANEL -->
  <div class="right">
    <div id="slideshowPanel" style="display:none;">
      <h3>Uploaded images</h3>
      <div id="thumbnails"></div>
      <div id="uploadStatus" style="display:none;">
        Uploading image…
      </div>

    </div>
  </div>

</div>

<script>
let lastLiveImage = null;
let lastRssTitle = null;

/* -----------------------------
   Initial load
----------------------------- */
async function load() {
  const settings = await fetch("/settings").then(r => r.json());

  document.getElementById("rssUrl").value = settings.rssUrl || "";

  if (settings.mode) {
    const radio = document.querySelector(
      `input[name="mode"][value="${settings.mode}"]`
    );
    if (radio) radio.checked = true;
  }

  document
    .querySelectorAll("input[name=mode]")
    .forEach(r =>
      r.addEventListener("change", updateSlideshowVisibility)
    );

  await refreshStatus();
  updateSlideshowVisibility();

  // Single polling loop
  setInterval(refreshStatus, 4000);
}

/* -----------------------------
   Save settings
----------------------------- */
async function save() {
  const rssUrl = document.getElementById("rssUrl").value;
  const modeInput = document.querySelector("input[name=mode]:checked");

  if (!modeInput) {
    alert("Please select a display mode");
    return;
  }

  await fetch("/settings", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      rssUrl,
      mode: modeInput.value
    })
  });

  await fetch("/refresh", { method: "POST" });
}

/* -----------------------------
   Upload image
----------------------------- */
async function upload() {
  const file = image.files[0];
  if (!file) return alert("Choose an image");

  const status = document.getElementById("uploadStatus");
  status.style.display = "block";
  status.innerText = `Uploading ${file.name}…`;

  const fd = new FormData();
  fd.append("image", file);

  try {
    await fetch("/upload", { method: "POST", body: fd });

    status.innerText = "Upload complete ✔";
    setTimeout(() => (status.style.display = "none"), 1200);

    loadSlideshowThumbnails();
  } catch {
    status.innerText = "Upload failed ✕";
  }
}

/* -----------------------------
   Core status sync
----------------------------- */
async function refreshStatus() {
  try {
    const status = await fetch("/status").then(r => r.json());

    // Scheduler info
    document.getElementById("status").innerHTML = `
      Last run: ${status.lastRun || "never"}<br>
      Last success: ${status.lastSuccess || "never"}<br>
      Error: ${status.lastError || "none"}
    `;

    // RSS LIVE preview
    const mode = document.querySelector(
      "input[name=mode]:checked"
    )?.value;

    if (mode === "rss" && status.currentTitle !== lastRssTitle) {
      lastRssTitle = status.currentTitle;
      document.getElementById("preview").innerText =
        status.currentTitle || "No RSS item";
    }

    // Slideshow LIVE highlight
    if (status.currentImage && status.currentImage !== lastLiveImage) {
      lastLiveImage = status.currentImage;
      loadSlideshowThumbnails();
    }
  } catch (err) {
    console.warn("Status sync failed:", err);
  }
}

/* -----------------------------
   Manual refresh
----------------------------- */
async function refreshDisplay() {
  await fetch("/refresh", { method: "POST" });
  // UI will update automatically via polling
}

/* -----------------------------
   Slideshow thumbnails
----------------------------- */
async function loadSlideshowThumbnails() {
  const res = await fetch("/slideshow");
  const images = await res.json();

  const container = document.getElementById("thumbnails");
  container.innerHTML = "";

  if (!images.length) {
    container.innerHTML = "<em>No images uploaded</em>";
    return;
  }

  images.forEach(img => {
    const wrapper = document.createElement("div");
    wrapper.className = "thumb";

    if (img.name === lastLiveImage) {
      wrapper.classList.add("current");
    }

    const el = document.createElement("img");
    el.src = img.url;
    el.alt = img.name;
    el.title = img.name;
    el.onclick = async () => {
      await fetch(`/slideshow/${encodeURIComponent(img.name)}/live`, { method: "POST" });
      lastLiveImage = img.name;
      loadSlideshowThumbnails(); // re-highlight
    };

    const del = document.createElement("button");
    del.innerText = "✕";
    del.title = "Delete image";

    del.onclick = async () => {
      if (!confirm(`Delete ${img.name}?`)) return;
      await fetch(`/slideshow/${encodeURIComponent(img.name)}`, {
        method: "DELETE"
      });
      loadSlideshowThumbnails();
    };

    wrapper.appendChild(el);
    wrapper.appendChild(del);
    container.appendChild(wrapper);
  });
}

/* -----------------------------
   Visibility toggle
----------------------------- */
function updateSlideshowVisibility() {
  const mode = document.querySelector(
    "input[name=mode]:checked"
  )?.value;

  const panel = document.getElementById("slideshowPanel");
  panel.style.display = mode === "slideshow" ? "block" : "none";

  if (mode === "slideshow") {
    loadSlideshowThumbnails();
  }
}

load();
</script>

</body>
</html>
